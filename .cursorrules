# N8N Ops - AI Assistant Rules

## Testing Requirements (MANDATORY)

**IMPORTANT: Always test changes before telling the user to test them.**

Before reporting that a change is complete or asking the user to test:

1. **Backend changes**: Run `pytest` or relevant test file to verify no regressions
2. **Frontend changes**: Run `npm run build` to catch TypeScript/compilation errors
3. **API changes**: Use `curl` or test the endpoint directly to verify it works
4. **Full-stack changes**: Verify both backend and frontend compile/pass tests

If tests fail, fix the issues before reporting completion. Do not hand off broken code to the user.

## Server and Port Rules (MANDATORY)

**Ask before restarting servers:**
- If a change requires restarting the backend or frontend server, **ASK THE USER FIRST**
- Do not restart servers without explicit permission
- Explain why the restart is needed before asking

**NEVER change ports without permission:**
- Port configuration in `.env.local` is sacred - **NEVER modify without asking**
- Do not change `VITE_API_BASE_URL`, `BACKEND_PORT`, `FRONTEND_PORT`, or any port settings
- If you believe a port change is needed, explain why and get explicit approval first

## Database Migrations

**CRITICAL**: When you make ANY database schema change, you MUST:

1. **Create an Alembic migration file** using the helper script:
   ```bash
   python n8n-ops-backend/scripts/create_migration.py "descriptive_name" --sql "YOUR_SQL_HERE"
   ```

2. The migration must include:
   - `upgrade()` function with the SQL (use `op.execute()` for raw SQL)
   - `downgrade()` function (can be `pass` if not reversible, or include reverse SQL)

3. **Add a code comment** where the schema is documented or referenced:
   ```python
   # Migration: <revision_id> - <description>
   # See: alembic/versions/XXXXX_<description>.py
   ```

4. **Inform the user**:
   - "Created migration: <filename>"
   - "Run: alembic upgrade head"

**Schema change triggers:**
- CREATE TABLE
- ALTER TABLE (ADD/DROP/MODIFY COLUMN)
- CREATE/DROP INDEX
- CREATE/DROP FUNCTION/TRIGGER
- CREATE/DROP VIEW
- Any SQL in code comments, documentation, or user requests
- Any mention of "add column", "create table", "schema change", etc.

**Migration naming convention:**
- Use descriptive, lowercase names with underscores
- Examples: "add_last_login_to_users", "create_audit_logs_table", "add_provider_column_to_environments"
- Timestamp is auto-generated by Alembic

**SQL best practices:**
- Use idempotent SQL when possible (IF NOT EXISTS, IF EXISTS)
- Always include both upgrade and downgrade functions
- Test migrations before committing

**Example workflow:**
User: "Add a provider column to environments table"
You should:
1. Create migration: `python n8n-ops-backend/scripts/create_migration.py "add_provider_to_environments" --sql "ALTER TABLE environments ADD COLUMN IF NOT EXISTS provider TEXT NOT NULL DEFAULT 'n8n';"`
2. Add comment in relevant code file: `# Migration: <revision_id> - Added provider column to environments`
3. Tell user: "Created migration. Run: alembic upgrade head"

## Code Style

- Follow existing patterns in the codebase
- Keep functions under 200-300 lines (refactor if needed)
- Avoid code duplication - check for existing similar functionality
- No comments unless necessary (API keys, etc.)
- Simple solutions preferred over complex ones

## Testing

- When adding new features, consider if tests are needed
- Use existing test patterns from the `tests/` directory
- Mock external API calls (n8n, GitHub, etc.)

## Project Structure

- Backend: `n8n-ops-backend/`
- Frontend: `n8n-ops-ui/`
- Database migrations: `n8n-ops-backend/alembic/versions/`
- Scripts: `n8n-ops-backend/scripts/`

